# üèïÔ∏è Sistema de Gesti√≥n Boy Scout - Grupo Lima 12

## üìã Descripci√≥n del Proyecto

Sistema web moderno y responsive para la gesti√≥n y registro de Boy Scouts del Grupo Lima 12. Desarrollado siguiendo las mejores pr√°cticas de UX/UI con dise√±o inspirado en aplicaciones modernas como las que se dise√±an en Figma.

## ‚ú® Caracter√≠sticas Principales

### üéØ Funcionalidades Core
- **Registro de Boy Scouts** con datos personales completos
- **Gesti√≥n de Familiares** con b√∫squeda inteligente
- **Asignaci√≥n de Ramas** seg√∫n edad autom√°tica
- **Validaci√≥n de Edad** por rama scout
- **Timeline de Progresi√≥n** entre ramas
- **Ubicaci√≥n Geogr√°fica** (Departamentos, Provincias, Distritos del Per√∫)

### üé® Dise√±o y UX
- **Dise√±o Responsive** compatible con m√≥viles, tablets y desktop
- **Interfaz Moderna** inspirada en mejores pr√°cticas de UI/UX
- **Paleta de Colores Scout** (verdes, naranjas, azules naturales)
- **Formulario Multi-paso** con indicador de progreso
- **Animaciones Suaves** y transiciones elegantes
- **Validaci√≥n en Tiempo Real** de campos

### üîß Tecnolog√≠as Utilizadas
- **HTML5** sem√°ntico y accesible
- **CSS3** con Custom Properties (Variables CSS)
- **JavaScript Vanilla** modular y orientado a objetos
- **Font Awesome** para iconograf√≠a
- **Google Fonts** (Inter) para tipograf√≠a moderna

## üîê Control de Acceso y Autorizaci√≥n

### Flujo de Acceso al Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    APP EN AZURE                             ‚îÇ
‚îÇ           tuapp.azurestaticapps.net                         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ              PANTALLA DE LOGIN                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ         (visible para TODOS)                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                          ‚îÇ                                  ‚îÇ
‚îÇ                          ‚ñº                                  ‚îÇ
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ              ‚îÇ Usuario ingresa su   ‚îÇ                       ‚îÇ
‚îÇ              ‚îÇ email y da clic      ‚îÇ                       ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ                          ‚îÇ                                  ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ           ‚ñº                             ‚ñº                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ Email EN tabla  ‚îÇ         ‚îÇ Email NO EN tabla       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ dirigentes_     ‚îÇ         ‚îÇ dirigentes_autorizados  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ autorizados     ‚îÇ         ‚îÇ                         ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ           ‚ñº                              ‚ñº                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ ‚úÖ ACCEDE AL    ‚îÇ         ‚îÇ ‚ùå "Tu email no est√°    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ   DASHBOARD     ‚îÇ         ‚îÇ    autorizado"          ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ¬øC√≥mo funciona?

| Concepto | Descripci√≥n |
|----------|-------------|
| **URL p√∫blica** | Cualquier persona puede ver la pantalla de login |
| **Contenido protegido** | Solo usuarios en la lista blanca pueden acceder al sistema |
| **Lista blanca** | Tabla `dirigentes_autorizados` en la base de datos |

### Paso a paso para dar acceso a un nuevo usuario

| Paso | Acci√≥n |
|------|--------|
| 1 | Despliegas la app en Azure ‚Üí `tuapp.azurestaticapps.net` |
| 2 | Le das la URL a la persona |
| 3 | La persona entra a la URL ‚Üí **Ve la pantalla de login** |
| 4 | La persona ingresa su email y da clic en "Enviar C√≥digo" |
| 5 | El sistema verifica si el email est√° en `dirigentes_autorizados` |
| 6 | **Si NO est√°** ‚Üí Mensaje "Tu email no est√° autorizado" |
| 7 | **Si S√ç est√°** ‚Üí Puede entrar al sistema |

### C√≥mo autorizar nuevos usuarios

**Opci√≥n A: Desde la UI (recomendado)**
1. Ingresas al sistema con tu cuenta autorizada
2. Vas a **Seguridad ‚Üí Usuarios ‚Üí Invitar Usuario**
3. Agregas el email del nuevo dirigente
4. Seleccionas su rol (Dirigente, Admin Grupo, Super Admin)
5. ¬°Listo! El nuevo usuario ya puede acceder

**Opci√≥n B: Desde SQL (solo casos especiales)**
```sql
INSERT INTO dirigentes_autorizados (email, nombre_completo, role, activo, grupo_scout_id)
VALUES (
  'nuevo.dirigente@gmail.com', 
  'Nombre Completo', 
  'dirigente',  -- o 'grupo_admin' o 'super_admin'
  true,
  (SELECT id FROM grupos_scout LIMIT 1)
);
```

### Roles disponibles

| Rol | Permisos |
|-----|----------|
| `dirigente` | Acceso b√°sico a m√≥dulos asignados |
| `grupo_admin` | Puede gestionar dirigentes y configuraci√≥n del grupo |
| `super_admin` | Acceso total al sistema |

## üìä Estructura de Ramas Scout

| Rama | Edad | Color | Icono | Caracter√≠sticas |
|------|------|-------|-------|----------------|
| **Manada** | 7-10 a√±os | Verde | üêæ | Seisenas, Lobatos/Lobatas |
| **Tropa** | 11-14 a√±os | Naranja | ü•æ | Patrullas, Gu√≠as, Scouts |
| **Caminante** | 15-17 a√±os | Azul | üß≠ | Exploraci√≥n, Liderazgo |
| **Clan** | 18-21 a√±os | Morado | ‚õ∞Ô∏è | Rovers, Servicio Comunitario |

## üóÇÔ∏è Estructura del Proyecto

```
laUniversidadDelEscultismo/
‚îú‚îÄ‚îÄ index.html                 # P√°gina principal
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.css          # Estilos principales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components.css    # Componentes espec√≠ficos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ responsive.css    # Dise√±o responsive
‚îÇ   ‚îî‚îÄ‚îÄ js/
‚îÇ       ‚îú‚îÄ‚îÄ data.js           # Datos y configuraci√≥n
‚îÇ       ‚îú‚îÄ‚îÄ main.js           # Aplicaci√≥n principal
‚îÇ       ‚îú‚îÄ‚îÄ form-steps.js     # Manejo de pasos del formulario
‚îÇ       ‚îú‚îÄ‚îÄ form-validation.js # Validaciones
‚îÇ       ‚îú‚îÄ‚îÄ location.js       # Manejo de ubicaciones
‚îÇ       ‚îî‚îÄ‚îÄ rama-logic.js     # L√≥gica de ramas scout
‚îî‚îÄ‚îÄ README.md                 # Documentaci√≥n
```

## üöÄ Instalaci√≥n y Uso

### Requisitos Previos
- Navegador web moderno (Chrome, Firefox, Safari, Edge)
- Servidor web local (opcional, para desarrollo)

### Instalaci√≥n
1. Clona o descarga el repositorio
2. Abre `index.html` en tu navegador
3. ¬°Listo para usar!

### Para Desarrollo Local
```bash
# Con Python (simple)
python -m http.server 8000

# Con Node.js (http-server)
npx http-server -p 8000

# Con PHP
php -S localhost:8000
```

Luego visita: `http://localhost:8000`

## üìù Gu√≠a de Uso

### 1. Datos Personales
- **Nombres y Apellidos**: Solo letras y espacios
- **Fecha de Nacimiento**: Calcula autom√°ticamente la edad
- **Ubicaci√≥n**: Selecci√≥n en cascada (Departamento ‚Üí Provincia ‚Üí Distrito)
- **Contacto**: Validaci√≥n de formatos peruanos
- **Foto**: Drag & drop, m√°ximo 5MB (JPG, PNG, GIF)

### 2. Datos del Familiar
- **B√∫squeda Inteligente**: Busca familiares existentes
- **Registro Nuevo**: Si no existe, se registra como nuevo
- **Parentesco**: Lista predefinida de opciones

### 3. Rama o Unidad Scout
- **Selecci√≥n Autom√°tica**: Sugiere rama seg√∫n edad
- **Validaci√≥n de Edad**: Alerta si no corresponde
- **Campos Espec√≠ficos**: Se generan din√°micamente seg√∫n la rama
- **Timeline Visual**: Muestra progresi√≥n entre ramas

## üéØ Validaciones Implementadas

### Datos Personales
- ‚úÖ Nombres: Solo letras, m√≠nimo 2 caracteres
- ‚úÖ Celular: 9 d√≠gitos, comenzando con 9
- ‚úÖ Edad: Entre 6 y 25 a√±os
- ‚úÖ Archivo: Tipos permitidos y tama√±o m√°ximo

### Datos Familiares
- ‚úÖ Campos obligatorios completados
- ‚úÖ Formato de tel√©fonos v√°lido

### Datos de Rama
- ‚úÖ Correspondencia edad-rama
- ‚úÖ Campos espec√≠ficos obligatorios
- ‚úÖ Fecha de ingreso v√°lida

## üé® Gu√≠a de Colores

```css
/* Colores Scout */
--primary-color: #2E7D4A;      /* Verde Scout */
--secondary-color: #F4A460;     /* Dorado Scout */
--accent-color: #1976D2;        /* Azul Scout */

/* Ramas */
--manada-color: #8BC34A;        /* Verde Manada */
--tropa-color: #FF9800;         /* Naranja Tropa */
--caminante-color: #2196F3;     /* Azul Caminante */
--clan-color: #9C27B0;          /* Morado Clan */
```

## üì± Responsive Design

### Breakpoints
- **Desktop**: > 1024px
- **Tablet**: 768px - 1024px
- **Mobile Large**: 480px - 768px
- **Mobile Small**: < 480px

### Adaptaciones M√≥viles
- Navegaci√≥n colapsible
- Formulario de una columna
- Timeline vertical
- Botones de ancho completo
- Tipograf√≠a escalable

## ‚ö° Caracter√≠sticas T√©cnicas

### Rendimiento
- **CSS Variables** para temas din√°micos
- **Lazy Loading** de validaciones
- **Debounced Search** para b√∫squedas
- **Optimizaci√≥n de Im√°genes** autom√°tica

### Accesibilidad
- **Sem√°ntica HTML** correcta
- **ARIA Labels** en elementos interactivos
- **Contraste de Colores** WCAG AA
- **Navegaci√≥n por Teclado** completa
- **Screen Reader** compatible

### Compatibilidad
- **ES6+** con fallbacks
- **CSS Grid** con flexbox de respaldo
- **Progressive Enhancement**
- **Graceful Degradation**

## üîÆ Caracter√≠sticas Futuras (Roadmap)

### Fase 2
- [ ] Backend API con Node.js/Express
- [ ] Base de datos MongoDB/PostgreSQL
- [ ] Autenticaci√≥n de usuarios
- [ ] Sistema de roles y permisos

### Fase 3
- [ ] Dashboard de administraci√≥n
- [ ] Reportes y estad√≠sticas
- [ ] Exportaci√≥n a PDF/Excel
- [ ] Notificaciones push

### Fase 4
- [ ] App m√≥vil nativa
- [ ] Integraci√≥n con sistemas externos
- [ ] API REST completa
- [ ] Tests automatizados

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT. Ver el archivo `LICENSE` para m√°s detalles.

## üë• Equipo de Desarrollo

- **Dise√±o UX/UI**: Inspirado en mejores pr√°cticas de Figma
- **Frontend**: HTML5, CSS3, JavaScript ES6+
- **Metodolog√≠a**: Mobile First, Progressive Enhancement

## üìû Contacto y Soporte

- **Grupo Scout**: Lima 12
- **Proyecto**: La Universidad del Escultismo
- **Email**: info@grupolima12.scout.pe
- **Web**: www.grupolima12.scout.pe

---

## üèïÔ∏è ¬°Siempre Listos! ‚öúÔ∏è

*Este sistema ha sido desarrollado con amor y dedicaci√≥n para facilitar la gesti√≥n de nuestros scouts y fortalecer el movimiento scout en el Per√∫.*
# Actualizaci√≥n Sun Nov  9 04:09:20 -05 2025


# URL
https://salmon-pebble-02073b20f.1.azurestaticapps.net

---

## üìä Tracking de Desarrollo con GitHub Copilot

### Sesi√≥n: 27 de enero de 2026 - M√≥dulo Finanzas

| # | Hora Inicio | Hora Fin | Duraci√≥n | Descripci√≥n del Prompt |
|---|-------------|----------|----------|------------------------|
| 1 | 01:45:00 | 01:55:00 | 10 min | Pregunta sobre actualizaci√≥n de UI "Pr√©stamos Pendientes" al registrar egreso con pr√©stamo |
| 2 | 01:55:00 | 02:10:00 | 15 min | Implementaci√≥n de secci√≥n pr√©stamo en formulario NuevaTransaccionDialog (checkbox, campos condicionales, validaci√≥n) |
| 3 | 02:10:00 | 02:12:00 | 2 min | Creaci√≥n componente Checkbox de Radix UI |
| 4 | 02:12:00 | 02:15:00 | 3 min | Instalaci√≥n dependencia @radix-ui/react-checkbox |
| 5 | 02:15:00 | 02:16:00 | 1 min | Reinicio servidor local |
| 6 | 02:16:00 | 02:21:00 | 5 min | Solicitud funcionalidad ver/editar transacciones |
| 7 | 02:21:00 | 02:35:00 | 14 min | Creaci√≥n DetalleTransaccionDialog (vista y edici√≥n), actualizaci√≥n TransaccionesTab con men√∫ mejorado |
| 8 | 02:35:00 | 02:37:00 | 2 min | Reinicio servidor y verificaci√≥n compilaci√≥n |
| 9 | 02:37:00 | 02:40:00 | 3 min | Documentaci√≥n tracking en README |
| 10 | 02:40:00 | 02:55:00 | 15 min | Error m√≥dulo Aire Libre "column a.codigo does not exist" - Correcci√≥n funciones SQL |
| 11 | 02:55:00 | 02:58:00 | 3 min | Reinicio servidor + actualizaci√≥n README con tracking |
| 12 | 02:58:00 | 03:15:00 | 17 min | Error "column p.dia_numero does not exist" - Correcci√≥n masiva de todas las funciones SQL de Actividades (programas, bloques, participantes, staff, presupuesto, documentos, menu, puntajes) |
| 13 | 03:15:00 | 03:25:00 | 10 min | Actualizaci√≥n interfaces TypeScript en actividadesExteriorService.ts para coincidir con schema SQL corregido |

### Resumen de la Sesi√≥n

| M√©trica | Valor |
|---------|-------|
| **Hora de inicio** | 01:45:00 AM (27 enero 2026) |
| **Hora de finalizaci√≥n** | 03:25:00 AM (27 enero 2026) |
| **Tiempo total** | 1 hora 40 minutos |
| **Total de prompts** | 13 |
| **Promedio por prompt** | ~7.7 minutos |

### Archivos Modificados/Creados

| Archivo | Acci√≥n | Descripci√≥n |
|---------|--------|-------------|
| `database/42_finanzas_functions.sql` | Modificado | Actualizado api_registrar_transaccion para aceptar prestamista_nombre sin ID |
| `database/43_actividades_functions.sql` | Modificado | Corregidas TODAS las funciones SQL con columnas del schema real |
| `src/services/actividadesExteriorService.ts` | Modificado | Actualizadas interfaces TypeScript para coincidir con schema SQL |
| `src/components/Finanzas/dialogs/NuevaTransaccionDialog.tsx` | Modificado | Agregada secci√≥n pr√©stamo con checkbox y campos condicionales |
| `src/components/ui/checkbox.tsx` | Creado | Nuevo componente Checkbox de Radix UI |
| `src/components/Finanzas/dialogs/DetalleTransaccionDialog.tsx` | Creado | Nuevo di√°logo para ver/editar transacciones |
| `src/components/Finanzas/tabs/TransaccionesTab.tsx` | Modificado | Integraci√≥n del di√°logo de detalles y men√∫ mejorado |

### Funcionalidades Implementadas

1. ‚úÖ **Registro de Egreso con Pr√©stamo**
   - Checkbox "Este gasto fue financiado con dinero prestado"
   - Campo monto cubierto con fondos propios
   - Campo nombre del prestamista
   - Selector tipo de prestamista (Dirigente, Padre, Scout, Externo)
   - Campo fecha l√≠mite de devoluci√≥n (opcional)
   - C√°lculo autom√°tico del monto prestado
   - Alerta visual mostrando monto del pr√©stamo

2. ‚úÖ **Ver Detalles de Transacci√≥n**
   - Monto destacado con color seg√∫n tipo
   - Grid de informaci√≥n (fecha, categor√≠a, m√©todo, proveedor)
   - Secci√≥n pr√©stamo asociado (si existe)
   - Galer√≠a de evidencias con preview
   - Notas internas

3. ‚úÖ **Editar Transacci√≥n**
   - Formulario inline en el mismo di√°logo
   - Campos editables: concepto, categor√≠a, monto, fecha, proveedor, m√©todo pago, notas
   - Guardado con toast de confirmaci√≥n
   - Actualizaci√≥n autom√°tica del dashboard

### Errores Encontrados y Soluciones

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| Falta componente Checkbox | No exist√≠a en ui/ | Creado `src/components/ui/checkbox.tsx` |
| Falta @radix-ui/react-checkbox | No instalado | `npm install @radix-ui/react-checkbox` |
| Pr√©stamo no se creaba | SQL requer√≠a prestamista_id | Modificado SQL para aceptar prestamista_nombre |
| "column a.codigo does not exist" | Funciones SQL referenciaban columnas inexistentes | Mapeado: `codigo‚Üíid::TEXT`, `ubicacion‚Üílugar`, `lugar_detalle‚Üídireccion`, `max_participantes‚Üícupo_maximo` |
| Columnas JSONB inexistentes en INSERT | api_crear_actividad insertaba en columnas que no existen | Removidas columnas inexistentes, a√±adidas columnas reales del schema |
| "column p.dia_numero does not exist" | programas_actividad no tiene dia_numero ni tema_del_dia | Corregido: usar `nombre`, `fecha`, `hora_inicio`, `hora_fin`, `orden` |
| Columnas bloques_programa incorrectas | actividad, materiales, notas, tipo_juego no existen | Corregido: usar `nombre`, `tipo_bloque`, `materiales_necesarios`, `otorga_puntaje`, `puntaje_maximo` |
| puntajes_actividad sin actividad_id | La tabla usa bloque_id, no actividad_id | Corregido: JOIN por bloques‚Üíprogramas‚Üíactividad, usar `observaciones` en vez de `motivo` |
| participantes_actividad sin patrulla_id | La tabla no tiene patrulla_id ni notas_medicas | Corregido: usar `restricciones_alimentarias`, `observaciones`, quitar LEFT JOIN patrullas |
| staff_actividad con dirigente_id | La tabla usa persona_id, no dirigente_id | Corregido: JOIN directo a personas |
| presupuesto_actividad con pagado/monto_pagado | La tabla usa monto_ejecutado | Corregido columnas |
| documentos_actividad con tipo_documento | La tabla usa `tipo` y no tiene fecha_vencimiento | Corregido columnas |
| menu_actividad con dia_numero/comida | La tabla usa `dia`, `tipo_comida`, `nombre_plato` | Corregido funci√≥n api_agregar_menu y query |

---

## üó∫Ô∏è Fix: Mapa de Ubicaci√≥n en Registro Scout v2 (31 Enero 2026)

### Problema Principal
Al editar un scout que ten√≠a ubicaci√≥n guardada, el mapa no mostraba la ubicaci√≥n existente.

### Investigaci√≥n y Diagn√≥stico

Se descubrieron **m√∫ltiples problemas en cadena**:

1. **Frontend - Conversi√≥n de tipos**: Los valores de lat/lng no se convert√≠an correctamente a n√∫meros
2. **Frontend - Sincronizaci√≥n de estado**: El componente `LocationPickerWeb` no sincronizaba cuando recib√≠a nuevos valores
3. **Frontend - Carga de datos incompleta**: Al editar, no se cargaban los datos completos del scout
4. **Frontend - Reset del formulario**: El formulario no se reseteaba cuando cambiaba el scout
5. **Backend - Funci√≥n incorrecta**: El frontend usaba `api_actualizar_scout`, pero se hab√≠a actualizado `api_actualizar_scout_completo`
6. **Backend - Campos no incluidos**: `api_actualizar_scout` no inclu√≠a los campos de ubicaci√≥n
7. **Backend - Operador JSON incorrecto**: Se us√≥ el operador `?` que solo funciona con JSONB
8. **Backend - Columna inexistente**: `fecha_registro` no existe en tabla `scouts`
9. **Backend - Error de tipos**: `create_standard_response` requiere casts expl√≠citos `::TEXT`, `::JSON`

### Archivos Modificados

#### Frontend

**[src/components/RegistroScout/components/DatosContacto.tsx](src/components/RegistroScout/components/DatosContacto.tsx)**
```typescript
// Agregado: Conversi√≥n expl√≠cita a n√∫meros
const lat = watchedLat != null ? Number(watchedLat) : null;
const lng = watchedLng != null ? Number(watchedLng) : null;
```

**[src/components/RegistroScout/components/LocationPickerWeb.tsx](src/components/RegistroScout/components/LocationPickerWeb.tsx)**
```typescript
// Agregado: useEffect para sincronizar cuando value cambia
useEffect(() => {
  if (value && (value.latitud !== selectedLocation?.latitud || ...)) {
    setSelectedLocation(value);
  }
}, [value?.latitud, value?.longitud, value?.direccion]);

// Mejorado: SafeInvalidateSize con verificaci√≥n _loaded
const safeInvalidateSize = () => {
  try {
    if (mapInstanceRef.current && 
        mapInstanceRef.current.getContainer() && 
        mapInstanceRef.current._loaded) {
      mapInstanceRef.current.invalidateSize();
    }
  } catch (e) { /* Ignore timing errors */ }
};
```

**[src/components/RegistroScout/v2/RegistroScoutPage.tsx](src/components/RegistroScout/v2/RegistroScoutPage.tsx)**
```typescript
// Cambiado: handleEditScout ahora es async y carga datos completos
const handleEditScout = useCallback(async (scout: Scout) => {
  const fullScout = await ScoutService.getScoutById(scout.id);
  setSelectedScout(fullScout || scout);
  setViewMode("edit");
}, []);
```

**[src/components/RegistroScout/v2/ScoutFormWizard.tsx](src/components/RegistroScout/v2/ScoutFormWizard.tsx)**
```typescript
// Agregado: Reset del formulario cuando cambia el scout
useEffect(() => {
  if (scout) {
    const formData = mapScoutToFormData(scout);
    form.reset(formData);
  }
}, [scout?.id, scout?.ubicacion_latitud, scout?.ubicacion_longitud]);
```

#### Scripts SQL Creados

| Script | Prop√≥sito |
|--------|-----------|
| `database/49_fix_dashboard_remove_es_dirigente.sql` | Elimina referencias a `es_dirigente` (columna eliminada), corrige `fecha_registro` ‚Üí `fecha_ingreso` |
| `database/50_fix_api_obtener_scout_con_ubicacion.sql` | Agrega campos `ubicacion_latitud`, `ubicacion_longitud`, `direccion_completa` al SELECT |
| `database/51_fix_api_actualizar_scout_con_ubicacion.sql` | Actualiza `api_actualizar_scout_completo` (no usada por frontend) |
| `database/52_fix_api_actualizar_scout_ubicacion.sql` | **CR√çTICO**: Actualiza `api_actualizar_scout` con campos de ubicaci√≥n |

### Errores Encontrados y Soluciones

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| Mapa no muestra ubicaci√≥n al editar | Frontend no sincronizaba selectedLocation | Agregado useEffect en LocationPickerWeb |
| `el._leaflet_pos` undefined | invalidateSize() antes de que Leaflet est√© listo | Verificaci√≥n `map._loaded` + try/catch |
| Ubicaci√≥n no se guarda | `api_actualizar_scout` no ten√≠a campos de ubicaci√≥n | Script 52 actualiza la funci√≥n |
| `operator does not exist: json ? unknown` | Operador `?` solo funciona con JSONB | Cambiado a `p_data->>'campo' IS NOT NULL` |
| `column fecha_registro does not exist` | Columna no existe en tabla scouts | Cambiado a `p.fecha_ingreso` de tabla personas |
| `es_dirigente does not exist` | Columna eliminada de scouts | Usar tabla `dirigentes` con EXISTS |
| `create_standard_response` type mismatch | Funci√≥n requiere tipos expl√≠citos | Agregados casts `::TEXT`, `::JSON` |
| Funci√≥n duplicada | M√∫ltiples firmas de `api_actualizar_scout` | DROP de todas las firmas antes de CREATE |

### Orden de Ejecuci√≥n de Scripts

```bash
# 1. Dashboard y estad√≠sticas
database/49_fix_dashboard_remove_es_dirigente.sql

# 2. Consultar scout con ubicaci√≥n
database/50_fix_api_obtener_scout_con_ubicacion.sql

# 3. Actualizar scout con ubicaci√≥n (LA QUE USA EL FRONTEND)
database/52_fix_api_actualizar_scout_ubicacion.sql
```

### Verificaci√≥n

```sql
-- Verificar que hay scouts con ubicaci√≥n guardada
SELECT p.nombres, p.apellidos, p.ubicacion_latitud, p.ubicacion_longitud
FROM personas p
JOIN scouts s ON s.persona_id = p.id
WHERE p.ubicacion_latitud IS NOT NULL
LIMIT 5;
```

### Lecciones Aprendidas

1. **Verificar qu√© funci√≥n usa el frontend**: El servicio usaba `api_actualizar_scout`, no `api_actualizar_scout_completo`
2. **JSON vs JSONB**: El operador `?` solo funciona con JSONB
3. **Leaflet timing**: Siempre verificar `map._loaded` antes de `invalidateSize()`
4. **Carga completa de datos**: Al editar, cargar datos frescos del backend con `getScoutById()`
5. **React Hook Form**: Usar `form.reset()` cuando cambia la entidad que se edita

---

## üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Fix: Soporte para N Familiares en Registro Scout (31 Enero 2026)

### Problema Principal
El sistema solo soportaba 1 familiar por scout (campos `familiar_*` en tabla `personas`). Se necesitaba soportar **N familiares** usando la tabla `familiares_scout`.

### S√≠ntomas Encontrados
1. Solo se guardaba 1 familiar aunque se agregaran m√°s en el formulario
2. Al editar un scout con 2 familiares, solo se mostraba 1 en la UI
3. Los familiares no se actualizaban correctamente al guardar

### Investigaci√≥n y Diagn√≥stico

Se descubrieron **m√∫ltiples problemas en cadena**:

| Capa | Problema | Causa |
|------|----------|-------|
| SQL | Solo guardaba 1 familiar | `api_actualizar_scout` solo actualizaba campos `familiar_*` en personas |
| SQL | No le√≠a familiares | `api_obtener_scout` no consultaba tabla `familiares_scout` |
| Frontend | `getFamiliaresByScout` retornaba vac√≠o | Acced√≠a a `data.familiares` en vez de `data.data.familiares` (response wrapper) |
| Frontend | UI mostraba 1 de 2 familiares | `useFieldArray` de React Hook Form no se actualizaba correctamente |

### Soluci√≥n Implementada

#### 1. SQL - CRUD Completo de Familiares

**Script:** `database/53_add_familiar_fields.sql`

**`api_obtener_scout`** - Ahora retorna array `familiares`:
```sql
-- Obtener TODOS los familiares de la tabla familiares_scout
SELECT COALESCE(json_agg(
    json_build_object(
        'id', fs.id,
        'nombres', pf.nombres,
        'apellidos', pf.apellidos,
        'parentesco', fs.parentesco,
        'celular', pf.celular,
        'correo', pf.correo,
        'es_contacto_emergencia', fs.es_contacto_emergencia,
        'es_apoderado', fs.es_autorizado_recoger
    ) ORDER BY fs.created_at ASC
), '[]'::json) INTO v_familiares
FROM familiares_scout fs
JOIN personas pf ON fs.persona_id = pf.id
WHERE fs.scout_id = p_scout_id;

-- Agregar al resultado
v_result := v_result::jsonb || jsonb_build_object('familiares', v_familiares);
```

**`api_actualizar_scout`** - CRUD completo para familiares:
```sql
-- Procesar array de familiares enviado
FOR v_familiar_item IN SELECT * FROM json_array_elements(p_data->'familiares')
LOOP
    -- Si tiene UUID v√°lido ‚Üí UPDATE existente
    -- Si no tiene UUID ‚Üí INSERT nuevo
    -- IDs no recibidos ‚Üí DELETE
END LOOP;
```

#### 2. Frontend - Extracci√≥n Correcta de Datos

**Archivo:** `src/services/scoutService.ts`

```typescript
static async getFamiliaresByScout(scoutId: string): Promise<any[]> {
  const { data } = await supabase.rpc('api_obtener_scout', { p_scout_id: scoutId });
  
  // Response viene envuelto en create_standard_response
  // Estructura: { success, message, data: { ...scout, familiares: [...] } }
  const scoutData = data?.data || data;
  const familiares = scoutData?.familiares || [];
  
  return familiares;
}
```

#### 3. Frontend - Fix de useFieldArray

**Archivo:** `src/components/RegistroScout/v2/ScoutFormWizard.tsx`

```typescript
// Problema: useFieldArray no detectaba cambios con form.setValue()
// Soluci√≥n: Forzar re-render con spread operator + setTimeout

form.setValue('familiares', familiaresMapped, { 
  shouldValidate: false,
  shouldDirty: false,
  shouldTouch: false 
});

// Forzar re-render despu√©s de un tick
setTimeout(() => {
  form.setValue('familiares', [...familiaresMapped]);
}, 100);
```

### Archivos Modificados

| Archivo | Cambios |
|---------|---------|
| `database/53_add_familiar_fields.sql` | CRUD completo: `api_obtener_scout` retorna array, `api_actualizar_scout` maneja INSERT/UPDATE/DELETE |
| `src/services/scoutService.ts` | `getFamiliaresByScout` accede a `data.data.familiares`, `updateScout` env√≠a array `familiares` |
| `src/components/RegistroScout/v2/ScoutFormWizard.tsx` | Logs de debug + setTimeout para forzar re-render de useFieldArray |

### Flujo de Datos Final

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        CREAR SCOUT                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Frontend                                                             ‚îÇ
‚îÇ   ScoutFormWizard.onSubmit()                                        ‚îÇ
‚îÇ     ‚Üì { ...scoutData, familiares: [...] }                          ‚îÇ
‚îÇ   ScoutService.createScout()                                        ‚îÇ
‚îÇ     ‚Üì RPC api_registrar_scout_completo                              ‚îÇ
‚îÇ Backend                                                              ‚îÇ
‚îÇ   1. INSERT INTO personas (scout)                                   ‚îÇ
‚îÇ   2. INSERT INTO scouts                                             ‚îÇ
‚îÇ   3. FOR cada familiar:                                             ‚îÇ
‚îÇ      - INSERT INTO personas (familiar)                              ‚îÇ
‚îÇ      - INSERT INTO familiares_scout                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        EDITAR SCOUT                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Frontend (Cargar)                                                    ‚îÇ
‚îÇ   ScoutService.getScoutById()                                       ‚îÇ
‚îÇ     ‚Üì RPC api_obtener_scout ‚Üí { ...scout, familiares: [...] }      ‚îÇ
‚îÇ   ScoutFormWizard.cargarFamiliaresScout()                          ‚îÇ
‚îÇ     ‚Üì form.setValue('familiares', familiaresMapped)                ‚îÇ
‚îÇ     ‚Üì setTimeout ‚Üí form.setValue([...familiaresMapped])  ‚Üê FIX!    ‚îÇ
‚îÇ   DatosFamiliares.tsx                                               ‚îÇ
‚îÇ     ‚Üì useFieldArray({ name: 'familiares' })                        ‚îÇ
‚îÇ     ‚Üì fields.map() ‚Üí Renderiza N tarjetas                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Frontend (Guardar)                                                   ‚îÇ
‚îÇ   ScoutFormWizard.onSubmit()                                        ‚îÇ
‚îÇ     ‚Üì { ...scoutData, familiares: [...] }                          ‚îÇ
‚îÇ   ScoutService.updateScout()                                        ‚îÇ
‚îÇ     ‚Üì RPC api_actualizar_scout                                      ‚îÇ
‚îÇ Backend                                                              ‚îÇ
‚îÇ   1. UPDATE personas SET ... (datos scout)                          ‚îÇ
‚îÇ   2. UPDATE scouts SET ... (rama, estado, etc)                      ‚îÇ
‚îÇ   3. FOR cada familiar recibido:                                    ‚îÇ
‚îÇ      - Si tiene UUID v√°lido y existe ‚Üí UPDATE                       ‚îÇ
‚îÇ      - Si no tiene UUID ‚Üí INSERT nuevo                              ‚îÇ
‚îÇ   4. FOR cada familiar existente no recibido:                       ‚îÇ
‚îÇ      - DELETE FROM familiares_scout                                 ‚îÇ
‚îÇ      - DELETE FROM personas (si no tiene otros v√≠nculos)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Lecciones Aprendidas

1. **React Hook Form + useFieldArray**: El `setValue()` no siempre dispara re-render. Usar spread operator `[...array]` + `setTimeout` para forzarlo.

2. **Response Wrapper**: Las funciones SQL usan `create_standard_response()` que envuelve los datos en `{ success, message, data }`. Hay que acceder a `response.data.data` para los datos reales.

3. **CRUD de Arrays en SQL**: Para manejar arrays (familiares) en PostgreSQL:
   - Guardar IDs existentes antes de procesar
   - Comparar IDs recibidos vs existentes
   - UPDATE los que coinciden, INSERT los nuevos, DELETE los que faltan

4. **Compatibilidad Legacy**: Mantener campos `familiar_*` en tabla `personas` para compatibilidad con c√≥digo antiguo, mientras se usa `familiares_scout` para N familiares.

5. **‚ö†Ô∏è Patrulla en Tabla Separada (miembros_patrulla)**: 
   - La patrulla del scout **NO se guarda** en las tablas `personas` ni `scouts`
   - Se guarda en la tabla `miembros_patrulla` como una **relaci√≥n separada**
   - `ScoutService.updateScout()` actualiza `personas` y `scouts`, pero **NO toca `miembros_patrulla`**
   - Para guardar la patrulla despu√©s de editar un scout, se debe hacer manualmente:
     ```typescript
     // 1. Marcar membres√≠a anterior como inactiva
     await supabase
       .from('miembros_patrulla')
       .update({ fecha_salida: new Date().toISOString().split('T')[0], estado_miembro: 'INACTIVO' })
       .eq('scout_id', scout.id)
       .is('fecha_salida', null);
     
     // 2. Crear nueva membres√≠a
     await supabase
       .from('miembros_patrulla')
       .insert({
         scout_id: scout.id,
         patrulla_id: data.patrulla_id,
         cargo_patrulla: data.cargo_patrulla || 'MIEMBRO',
         fecha_ingreso: new Date().toISOString().split('T')[0],
         estado_miembro: 'ACTIVO'
       });
     ```
   - **Columnas de miembros_patrulla**: `id`, `scout_id`, `patrulla_id`, `cargo_patrulla`, `fecha_ingreso`, `fecha_salida`, `estado_miembro`
   - **Valores de cargo_patrulla**: `'GUIA'`, `'SUBGUIA'`, `'TESORERO'`, `'SECRETARIO'`, `'MIEMBRO'`

---

## ÔøΩ Implementaci√≥n de Permisos RBAC en Componentes

### Resumen de la Soluci√≥n

El sistema implementa **Role-Based Access Control (RBAC)** verificando permisos antes de cada operaci√≥n CRUD. Cada componente importa el hook `usePermissions` y valida los permisos correspondientes antes de permitir acciones.

### Patr√≥n de Implementaci√≥n

```tsx
// 1. Importar hook de permisos
import { usePermissions } from '../../contexts/PermissionsContext';

// 2. Usar hook en el componente
const { puedeCrear, puedeEditar, puedeEliminar } = usePermissions();

// 3. Verificar en handlers antes de ejecutar
const handleCreateItem = async () => {
  if (!puedeCrear('modulo_nombre')) {
    alert('No tienes permiso para crear registros');
    return;
  }
  // ... l√≥gica de creaci√≥n
};

// 4. Ocultar botones condicionalmente
{puedeEditar('modulo_nombre') && (
  <button onClick={handleEdit}>‚úèÔ∏è Editar</button>
)}

{puedeEliminar('modulo_nombre') && (
  <button onClick={handleDelete}>üóëÔ∏è Eliminar</button>
)}
```

### M√≥dulos con Permisos Implementados

#### **Scouts**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `ListaScouts.tsx` | `puedeEditar`, `puedeEliminar` | Oculta botones de edici√≥n/eliminaci√≥n |
| `EditarScoutModal.tsx` | `puedeEditar` | Valida antes de guardar cambios |
| `ScoutFormWizard.tsx` | `puedeCrear`, `puedeEditar` | Valida en onSubmit seg√∫n modo |

#### **Dirigentes**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `DirigentesV2.tsx` | `puedeCrear`, `puedeEditar` | Valida en nuevo/editar dirigente |

#### **Finanzas**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `FinanzasDashboard.tsx` | `puedeCrear` | Oculta botones de nueva transacci√≥n |
| `TransaccionesTab.tsx` | `puedeEditar`, `puedeEliminar` | Oculta items del dropdown |
| `PrestamosTab.tsx` | `puedeEditar`, `puedeEliminar` | Valida pagos y cancelaciones |

#### **Patrullas**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `Patrullas.tsx` | `puedeCrear`, `puedeEditar`, `puedeEliminar` | CRUD completo protegido |

#### **Inventario**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `Inventario.tsx` | `puedeCrear`, `puedeEditar`, `puedeEliminar` | CRUD completo protegido |

#### **Asistencia**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `Asistencia.tsx` | `puedeCrear`, `puedeEditar`, `puedeEliminar` | Gesti√≥n de reuniones protegida |

#### **Actividades Scout**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `ActividadesScoutMigrated.tsx` | `puedeCrear`, `puedeEditar`, `puedeEliminar` | CRUD de actividades protegido |

#### **Actividades Exterior**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `ActividadesExteriorDashboard.tsx` | `puedeCrear` | Bot√≥n "Nueva Actividad" |
| `ActividadDetalle.tsx` | `puedeCrear`, `puedeEditar`, `puedeEliminar` | Programa, presupuesto, men√∫, compras, participantes, puntajes |

#### **Progresi√≥n**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `ScoutProgresionDetail.tsx` | `puedeEditar` | Toggle objetivos y asignar etapa |

#### **Comit√© de Padres**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `ComitePadresMigrated.tsx` | `puedeCrear`, `puedeEliminar` | Registrar y remover miembros |

#### **Libro de Oro**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `LibroOroMigrated.tsx` | `puedeCrear` | Crear nuevas entradas |

#### **Programa Semanal**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `ProgramaSemanalMigrated.tsx` | `puedeCrear` | Guardar programas |

#### **Documentos/Reportes**
| Archivo | Permisos | Descripci√≥n |
|---------|----------|-------------|
| `TemplateManager.tsx` | `puedeCrear`, `puedeEliminar` | Gesti√≥n de plantillas |

### Nombres de M√≥dulos para Permisos

| M√≥dulo | Nombre para `usePermissions()` |
|--------|-------------------------------|
| Scouts | `'scouts'` |
| Dirigentes | `'dirigentes'` |
| Finanzas | `'finanzas'` |
| Patrullas | `'patrullas'` |
| Inventario | `'inventario'` |
| Asistencia | `'asistencia'` |
| Actividades Scout | `'actividades'` |
| Actividades Exterior | `'actividades_exterior'` |
| Progresi√≥n | `'progresion'` |
| Comit√© de Padres | `'comite_padres'` |
| Libro de Oro | `'libro_oro'` |
| Programa Semanal | `'programa_semanal'` |
| Reportes | `'reportes'` |

### C√≥mo Agregar Permisos a un Nuevo Componente

1. **Importar el hook:**
   ```tsx
   import { usePermissions } from '../../contexts/PermissionsContext';
   ```

2. **Usar en el componente:**
   ```tsx
   const { puedeCrear, puedeEditar, puedeEliminar, puedeExportar } = usePermissions();
   ```

3. **Validar en handlers:**
   ```tsx
   const handleNuevoRegistro = () => {
     if (!puedeCrear('mi_modulo')) {
       alert('No tienes permiso para crear registros');
       return;
     }
     // Continuar con la l√≥gica
   };
   ```

4. **Ocultar elementos UI:**
   ```tsx
   {puedeCrear('mi_modulo') && (
     <Button onClick={handleNuevoRegistro}>
       <Plus /> Nuevo
     </Button>
   )}
   ```

### Roles y Niveles de Acceso

| Rol | Nivel | Descripci√≥n |
|-----|-------|-------------|
| `super_admin` | 100 | Acceso total a todo el sistema |
| `jefe_grupo` | 90 | Administrador del grupo scout |
| `coordinador` | 70 | Coordinador de rama/√°rea |
| `dirigente` | 50 | Dirigente activo |
| `asistente` | 30 | Asistente de dirigente |
| `padre_familia` | 20 | Padre de familia de scout |
| `scout` | 10 | Scout (acceso limitado) |

### Verificaci√≥n de Permisos en Base de Datos

La funci√≥n `tiene_permiso()` en PostgreSQL verifica:

```sql
SELECT tiene_permiso(
  'user-uuid',      -- ID del usuario
  'scouts',         -- M√≥dulo
  'editar'          -- Acci√≥n: leer, crear, editar, eliminar, exportar
);
```

---

## ÔøΩüîÆ Mejoras Futuras - Permisos Granulares

### Separaci√≥n de Permisos de Visualizaci√≥n

Actualmente el sistema maneja permisos a nivel de m√≥dulo con acciones (leer, crear, editar, eliminar, exportar). Para el futuro se puede implementar mayor granularidad:

#### Nivel 1: Separar "Ver m√≥dulo" de "Ver detalle"

| Permiso | Descripci√≥n | Ejemplo |
|---------|-------------|---------|
| `leer` | Acceder a la secci√≥n/m√≥dulo | Ver la lista de scouts |
| `ver_detalle` | Ver informaci√≥n de un registro espec√≠fico | Ver ficha completa de un scout |

**Caso de uso:**
- Un padre de familia podr√≠a ver el m√≥dulo "Scouts" pero solo los detalles de **SU hijo**
- Un coordinador de Tropa ver√≠a solo scouts de **su rama**

#### Nivel 2: Row Level Security (RLS) Avanzado

Implementar pol√≠ticas de seguridad a nivel de fila para control granular:

```sql
-- Ejemplo: Padre solo ve sus hijos
CREATE POLICY padre_ve_sus_hijos ON scouts
FOR SELECT
USING (
  auth.uid() IN (
    SELECT familiar_id FROM scout_familiares 
    WHERE scout_id = scouts.id
  )
);

-- Ejemplo: Coordinador ve scouts de su rama
CREATE POLICY coordinador_ve_su_rama ON scouts
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM usuario_ramas ur
    WHERE ur.user_id = auth.uid()
    AND ur.rama = scouts.rama_actual
  )
);
```

#### Nivel 3: Permisos por Rama

| Rol | Dashboard | Scouts | Finanzas | Reportes |
|-----|-----------|--------|----------|----------|
| Jefe de Grupo | ‚úÖ Todo | ‚úÖ Todo | ‚úÖ Todo | ‚úÖ Todo |
| Coordinador Tropa | ‚úÖ | Solo Tropa | Solo Tropa | Solo Tropa |
| Dirigente Manada | ‚úÖ | Solo Manada | ‚ùå | Solo Manada |
| Padre de Familia | ‚ùå | Solo su hijo | ‚ùå | ‚ùå |

#### Implementaci√≥n Propuesta

**1. Nueva tabla `usuario_ramas`:**
```sql
CREATE TABLE usuario_ramas (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  rama VARCHAR(20) NOT NULL,
  es_coordinador BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**2. Modificar funci√≥n `tiene_permiso`:**
```sql
CREATE OR REPLACE FUNCTION tiene_permiso_granular(
  p_user_id UUID,
  p_modulo VARCHAR(50),
  p_accion VARCHAR(20),
  p_rama VARCHAR(20) DEFAULT NULL,
  p_registro_id UUID DEFAULT NULL
)
RETURNS BOOLEAN AS $$
BEGIN
  -- Verificar permiso base
  IF NOT tiene_permiso(p_user_id, p_modulo, p_accion) THEN
    RETURN FALSE;
  END IF;
  
  -- Si es super_admin o jefe_grupo, acceso total
  IF es_admin_global(p_user_id) THEN
    RETURN TRUE;
  END IF;
  
  -- Verificar acceso por rama
  IF p_rama IS NOT NULL THEN
    RETURN EXISTS (
      SELECT 1 FROM usuario_ramas 
      WHERE user_id = p_user_id AND rama = p_rama
    );
  END IF;
  
  -- Verificar acceso por registro (para padres)
  IF p_registro_id IS NOT NULL THEN
    RETURN es_familiar_de_scout(p_user_id, p_registro_id);
  END IF;
  
  RETURN TRUE;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**3. Actualizar contexto en frontend:**
```typescript
interface PermissionsContextType {
  // Existentes
  puedeAcceder: (modulo: Modulo) => boolean;
  puedeCrear: (modulo: Modulo) => boolean;
  // Nuevos
  puedeVerDetalle: (modulo: Modulo, registroId?: string) => boolean;
  puedeAccederRama: (modulo: Modulo, rama: string) => boolean;
  ramasAsignadas: string[];
}
```

### Archivos a Modificar

| Archivo | Cambios |
|---------|---------|
| `database/permisos_granulares.sql` | Crear tablas y funciones |
| `src/services/permissionsService.ts` | Agregar m√©todos granulares |
| `src/contexts/PermissionsContext.tsx` | Exponer nuevos checks |
| `src/components/Scouts/ScoutsList.tsx` | Filtrar por rama/registro |

### Prioridad de Implementaci√≥n

1. üü° **Media** - Separar `leer` de `ver_detalle` (2-3 horas)
2. üü† **Alta complejidad** - RLS por rama (4-6 horas)
3. üî¥ **Alta complejidad** - RLS por registro/familiar (6-8 horas)

> **Nota:** El sistema actual es "todo o nada" por m√≥dulo. Implementar estas mejoras cuando haya casos de uso concretos que lo requieran.

---